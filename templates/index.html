<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Arrendamento T2 (‚Ç¨/m¬≤)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding: 18px; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small-note { color: #666; font-size: 0.9rem; }
    table td { vertical-align: middle; }
    table thead th { position: sticky; top: 0; background: var(--bs-body-bg); z-index: 1; }
    .badge-source { text-transform: uppercase; letter-spacing: .02em; }
    .badge-pink { background-color: #d63384; color: #fff; }
    .row-discarded { opacity: 0.55; }
    .actions .btn { padding: .15rem .4rem; font-size: .85rem; }
    .title-cell .status-badges { margin-left: .4rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h3 class="mb-3">Arrendamento ‚Äî ordenar por ‚Ç¨/m¬≤</h3>

    <div class="row g-3">
      <div class="col-lg-2">
        <label class="form-label">Distrito</label>
        <select id="district" class="form-select">
          {% for d in districts %}
            <option value="{{d}}" {% if d == default_district %}selected{% endif %}>{{d}}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-lg-2">
        <label class="form-label">Tipologia</label>
        <select id="typology" class="form-select">
          <option value="T*">T*</option>
          <option value="T0">T0</option>
          <option value="T1">T1</option>
          <option value="T1+1">T1+1</option>
          <option value="T2" selected>T2</option>
          <option value="T2+1">T2+1</option>
          <option value="T3">T3</option>
          <option value="T4">T4</option>
          <option value="T5">T5</option>
        </select>
      </div>

      <div class="col-lg-2">
        <label class="form-label">P√°ginas por site</label>
        <input id="pages" type="number" min="1" max="10" class="form-control" value="2">
      </div>

      <div class="col-lg-2">
        <label class="form-label">Limite resultados</label>
        <input id="limit" type="number" min="10" max="1000" class="form-control" value="50">
      </div>

      <div class="col-lg-2">
        <label class="form-label">Ordenar</label>
        <select id="sort" class="form-select">
          <option value="eur_m2_asc" selected>‚Ç¨/m¬≤ (asc)</option>
          <option value="eur_m2_desc">‚Ç¨/m¬≤ (desc)</option>
          <option value="price_asc">Pre√ßo (asc)</option>
          <option value="price_desc">Pre√ßo (desc)</option>
        </select>
      </div>

      <div class="col-lg-2 d-flex align-items-end">
        <button id="btnRefresh" class="btn btn-primary w-100">Atualizar</button>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-lg-3">
        <div class="card p-3">
          <div class="fw-semibold mb-2">Fontes</div>
          <div class="form-check"><input class="form-check-input source" type="checkbox" value="idealista" checked> <label class="form-check-label">Idealista</label></div>
          <div class="form-check"><input class="form-check-input source" type="checkbox" value="imovirtual" checked> <label class="form-check-label">Imovirtual</label></div>
          <div class="form-check"><input class="form-check-input source" type="checkbox" value="supercasa" checked> <label class="form-check-label">SUPERCASA</label></div>
          <div class="form-check"><input class="form-check-input source" type="checkbox" value="casasapo" checked> <label class="form-check-label">CASA SAPO</label></div>
          <div class="form-check"><input class="form-check-input source" type="checkbox" value="remax" checked> <label class="form-check-label">RE/MAX</label></div>
          <div class="form-check"><input class="form-check-input source" type="checkbox" value="olx" checked> <label class="form-check-label">OLX</label></div>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="card p-3">
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label">Pre√ßo min (‚Ç¨)</label>
              <input id="min_price" class="form-control" placeholder="ex: 600">
            </div>
            <div class="col-md-3">
              <label class="form-label">Pre√ßo max (‚Ç¨)</label>
              <input id="max_price" class="form-control" placeholder="ex: 1200">
            </div>
            <div class="col-md-3">
              <label class="form-label">√Årea min (m¬≤)</label>
              <input id="min_area" class="form-control" placeholder="ex: 60">
            </div>
            <div class="col-md-3">
              <label class="form-label">√Årea max (m¬≤)</label>
              <input id="max_area" class="form-control" placeholder="ex: 140">
            </div>
          </div>

          <div class="row g-2 mt-1">
            <div class="col-md-4">
              <div class="form-check mt-4">
                <input id="only_with_eurm2" class="form-check-input" type="checkbox">
                <label class="form-check-label">S√≥ com ‚Ç¨/m¬≤ calculado</label>
              </div>
            </div>
            <div class="col-md-5">
              <div class="form-check mt-4">
                <input id="exclude_temporary" class="form-check-input" type="checkbox" checked>
                <label class="form-check-label">Excluir ‚Äútempor√°rio/subloca√ß√£o‚Äù (heur√≠stica)</label>
              </div>
            </div>
            <div class="col-md-3 d-flex align-items-end justify-content-end">
              <div id="summary" class="small-note text-end"></div>
            </div>
          </div>

          <hr class="my-3">

          <div class="row g-3">
            <div class="col-md-6">
              <canvas id="chartBySource"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="chartMedian"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3 card p-3">
      <div class="d-flex justify-content-end gap-4 mb-2">
        <div class="form-check"><input id="hide_discarded" class="form-check-input" type="checkbox"> <label class="form-check-label ms-1" for="hide_discarded">Ocultar descartados</label></div>
        <div class="form-check"><input id="only_loved" class="form-check-input" type="checkbox"> <label class="form-check-label ms-1" for="only_loved">S√≥ favoritos</label></div>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead>
            <tr>
              <th>Fonte</th>
              <th>An√∫ncio</th>
              <th class="text-end">Pre√ßo</th>
              <th class="text-end">√Årea</th>
              <th class="text-end">‚Ç¨/m¬≤</th>
              <th>Link</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="small-note">Dica: aumenta ‚ÄúP√°ginas por site‚Äù para cobrir mais an√∫ncios (vai demorar mais).</div>
    </div>
  </div>

  <script>
    let chartBySource = null;
    let chartMedian = null;

    // Persistent marks (Loved/Discarded)
    let MARKS = {};
    let LAST_DATA = null; // { results, stats }

    function loadMarksLocal() {
      try {
        MARKS = JSON.parse(localStorage.getItem('imo_marks') || '{}') || {};
      } catch (_) { MARKS = {}; }
    }
    function saveMarksLocal() {
      try { localStorage.setItem('imo_marks', JSON.stringify(MARKS)); } catch (_) {}
    }
    async function loadMarks() {
      loadMarksLocal();
      try {
        const res = await fetch('/api/marks');
        if (res.ok) {
          const remote = await res.json();
          // Merge: remote overwrites local
          MARKS = Object.assign({}, MARKS, remote || {});
          saveMarksLocal();
        }
      } catch (_) { /* offline or no server marks, ignore */ }
    }
    async function postMark(url, state) {
      try {
        await fetch('/api/marks', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, state })
        });
      } catch (_) { /* ignore */ }
    }
    function getMark(url) { return MARKS[url] || null; }

    function saveUIState() {
      const s = {
        hide_discarded: document.getElementById('hide_discarded').checked ? 1 : 0,
        only_loved: document.getElementById('only_loved').checked ? 1 : 0,
      };
      try { localStorage.setItem('imo_ui', JSON.stringify(s)); } catch (_) {}
    }
    function restoreUIState() {
      try {
        const s = JSON.parse(localStorage.getItem('imo_ui') || '{}') || {};
        if (typeof s.hide_discarded !== 'undefined') document.getElementById('hide_discarded').checked = !!s.hide_discarded;
        if (typeof s.only_loved !== 'undefined') document.getElementById('only_loved').checked = !!s.only_loved;
      } catch (_) {}
    }

    function badgesFor(url) {
      const st = getMark(url);
      let html = '';
      if (st === 'loved') html += '<span class="badge badge-pink ms-1">Favorito</span>';
      if (st === 'discarded') html += '<span class="badge text-bg-dark ms-1">Descartado</span>';
      return html;
    }

    function applyLocalFilters(arr) {
      const hideDiscarded = document.getElementById('hide_discarded').checked;
      const onlyLoved = document.getElementById('only_loved').checked;
      return arr.filter(x => {
        const m = getMark(x.url);
        if (onlyLoved) return m === 'loved';
        if (hideDiscarded && m === 'discarded') return false;
        return true;
      });
    }

    function median(values) {
      const nums = values.slice().sort((a,b)=>a-b);
      const n = nums.length; if (!n) return null;
      const mid = Math.floor(n/2);
      return n % 2 ? nums[mid] : (nums[mid-1] + nums[mid]) / 2;
    }

    function renderFromLast() {
      if (!LAST_DATA) return;
      const data = LAST_DATA;
      const all = data.results || [];
      const filtered = applyLocalFilters(all);

      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      for (const x of filtered) {
        const loved = getMark(x.url) === 'loved';
        const discarded = getMark(x.url) === 'discarded';
        const tr = document.createElement('tr');
        if (discarded) tr.classList.add('row-discarded');
        tr.innerHTML = `
          <td>${sourceBadge(x.source)}</td>
          <td class="title-cell">${(x.title || '‚Äî')} <span class="status-badges">${badgesFor(x.url)}</span></td>
          <td class="text-end mono">${money(x.price_eur)}</td>
          <td class="text-end mono">${x.area_m2 ? num(x.area_m2) + ' m¬≤' : '‚Äî'}</td>
          <td class="text-end mono">${x.eur_m2 ? num(x.eur_m2) : '‚Äî'}</td>
          <td><a href="${x.url}" target="_blank" rel="noopener">abrir</a></td>
          <td class="actions text-nowrap">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-secondary btn-love" title="${loved ? 'Remover favorito' : 'Marcar favorito'}" aria-label="toggle favorite" data-url="${x.url}">${loved ? '‚ù§' : '‚ô°'}</button>
              <button type="button" class="btn btn-outline-secondary btn-discard" title="${discarded ? 'Repor' : 'Descartar'}" aria-label="toggle discard" data-url="${x.url}">üóë</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Summary text
      const typ = document.getElementById('typology').value;
      const med = median(filtered.filter(x=>x.eur_m2!==null && x.eur_m2!==undefined).map(x=>x.eur_m2));
      document.getElementById('summary').textContent = `${filtered.length} de ${data.stats.count} resultados ‚Ä¢ Tipologia: ${typ} ‚Ä¢ mediana ‚Ç¨/m¬≤ (vis√≠veis): ${med ? num(med) : '‚Äî'}`;

      // Charts from the filtered results
      const bySource = {};
      for (const x of filtered) bySource[x.source] = (bySource[x.source] || 0) + 1;
      const labels = Object.keys(bySource);
      const counts = labels.map(k => bySource[k]);
      if (chartBySource) chartBySource.destroy();
      chartBySource = new Chart(document.getElementById('chartBySource'), {
        type: 'bar', data: { labels, datasets: [{ label: 'An√∫ncios (vis√≠veis)', data: counts }] }, options: { responsive: true }
      });

      const groups = {};
      for (const x of filtered) {
        if (x.eur_m2 === null || x.eur_m2 === undefined) continue;
        (groups[x.source] = groups[x.source] || []).push(x.eur_m2);
      }
      const mLabels = Object.keys(groups);
      const medians = mLabels.map(k => median(groups[k]));
      if (chartMedian) chartMedian.destroy();
      chartMedian = new Chart(document.getElementById('chartMedian'), {
        type: 'bar', data: { labels: mLabels, datasets: [{ label: 'Mediana ‚Ç¨/m¬≤ (vis√≠veis)', data: medians }] }, options: { responsive: true }
      });
    }

    function money(v) {
      if (v === null || v === undefined) return "‚Äî";
      return new Intl.NumberFormat("pt-PT", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }).format(v);
    }
    function num(v) {
      if (v === null || v === undefined) return "‚Äî";
      return new Intl.NumberFormat("pt-PT", { maximumFractionDigits: 2 }).format(v);
    }

    function selectedSources() {
      return Array.from(document.querySelectorAll(".source:checked")).map(x => x.value);
    }

    function sourceBadgeClass(src) {
      switch ((src || '').toLowerCase()) {
        case 'idealista': return 'warning';
        case 'imovirtual': return 'info';
        case 'supercasa': return 'primary';
        case 'casasapo': return 'secondary';
        case 'remax': return 'danger';
        case 'olx': return 'success';
        default: return 'dark';
      }
    }
    function sourceBadge(src) {
      const cls = sourceBadgeClass(src);
      return `<span class="badge rounded-pill text-bg-${cls} badge-source">${src}</span>`;
    }

    async function refresh() {
      const btn = document.getElementById('btnRefresh');
      const oldBtnHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>A carregar‚Ä¶';

      try {
        const params = new URLSearchParams();
        params.set("district", document.getElementById("district").value);
        params.set("pages", document.getElementById("pages").value);
        params.set("limit", document.getElementById("limit").value);
        params.set("sort", document.getElementById("sort").value);
        params.set("typology", document.getElementById("typology").value);

        const min_price = document.getElementById("min_price").value.trim();
        const max_price = document.getElementById("max_price").value.trim();
        const min_area  = document.getElementById("min_area").value.trim();
        const max_area  = document.getElementById("max_area").value.trim();
        if (min_price) params.set("min_price", min_price);
        if (max_price) params.set("max_price", max_price);
        if (min_area) params.set("min_area", min_area);
        if (max_area) params.set("max_area", max_area);

        params.set("only_with_eurm2", document.getElementById("only_with_eurm2").checked ? "1" : "0");
        params.set("exclude_temporary", document.getElementById("exclude_temporary").checked ? "1" : "0");

        for (const s of selectedSources()) params.append("sources", s);

        document.getElementById("summary").textContent = "A carregar‚Ä¶";

        const res = await fetch("/api/listings?" + params.toString());
        if (!res.ok) throw new Error('Erro a carregar dados');
        const data = await res.json();
        LAST_DATA = data;
        renderFromLast();
      } catch (err) {
        console.error(err);
        document.getElementById("summary").textContent = "Falha ao carregar. Tenta novamente.";
      } finally {
        btn.disabled = false;
        btn.innerHTML = oldBtnHTML;
      }
    }

    document.getElementById("btnRefresh").addEventListener("click", refresh);
    document.getElementById("typology").addEventListener("change", refresh);
    document.getElementById("hide_discarded").addEventListener("change", () => { saveUIState(); renderFromLast(); });
    document.getElementById("only_loved").addEventListener("change", () => { saveUIState(); renderFromLast(); });

    // Actions (event delegation)
    document.getElementById("tbody").addEventListener("click", (ev) => {
      const btn = ev.target.closest('.btn-love, .btn-discard');
      if (!btn) return;
      const url = btn.getAttribute('data-url');
      if (!url) return;
      let state = null;
      if (btn.classList.contains('btn-love')) {
        state = (MARKS[url] === 'loved') ? null : 'loved';
      } else if (btn.classList.contains('btn-discard')) {
        state = (MARKS[url] === 'discarded') ? null : 'discarded';
      }
      if (state) {
        MARKS[url] = state;
      } else {
        delete MARKS[url];
      }
      saveMarksLocal();
      postMark(url, state || '');
      renderFromLast();
    });

    window.addEventListener("load", async () => {
      restoreUIState();
      await loadMarks();
      await refresh();
    });
  </script>
</body>
</html>
